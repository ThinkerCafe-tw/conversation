"""
笑話內容種子資料生成器
由笑話大師和內容創作大神聯合創作
包含各種類型的中文笑話和趣味內容
"""

import os
import logging
from datetime import datetime
from google.cloud import firestore
import random
from dotenv import load_dotenv

# 載入環境變數
load_dotenv()

# 設定日誌
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# 笑話大師精選集 - 各種類型的中文笑話
JOKES_COLLECTION = [
    # === 程式設計師笑話 ===
    {
        "category": "程式設計",
        "jokes": [
            "為什麼程式設計師不喜歡大自然？因為大自然有太多 bugs！",
            "程式設計師的老婆說：「你能去商店買一瓶牛奶嗎？如果有雞蛋的話，買六個。」於是他買了六瓶牛奶回來。",
            "如何判斷一個人是不是程式設計師？問他陣列是從 0 還是從 1 開始數。",
            "程式設計師最討厭的兩件事：1. 寫文件 2. 別人不寫文件",
            "老闆：這個專案很簡單，大概兩個禮拜就能完成。程式設計師：沒問題，您要哪兩個禮拜？明年的還是後年的？",
            "為什麼程式設計師總是分不清萬聖節和聖誕節？因為 Oct 31 = Dec 25",
            "一個程式設計師退休了，他的妻子讓他去買一條麵包，如果有雞蛋就買一打。結果他買了12條麵包回來。",
            "Debug 的定義：像偵探一樣找出問題，然後發現兇手就是你自己。",
            "程式設計師的笑話：「我的程式碼沒有 bug，那些都是未公開的 feature。」",
            "為什麼程式設計師喜歡黑暗模式？因為光明正大地寫 bug 太丟臉了。"
        ]
    },
    
    # === 日常生活笑話 ===
    {
        "category": "日常生活",
        "jokes": [
            "醫生：你要減肥了。病人：我有在運動啊！醫生：什麼運動？病人：我每天都在跑...跑去買珍奶。",
            "老師問小明：「如果你有十塊錢，你弟弟跟你要五塊，你還剩幾塊？」小明：「十塊。」老師：「你數學怎麼學的？」小明：「你不了解我弟弟。」",
            "妻子：親愛的，我剛剛撞壞了你的車。丈夫：沒關係，最重要的是你有沒有受傷？妻子：沒有，我是在家裡撞的。",
            "去健身房最大的運動量是什麼？從家裡走到健身房的那段路。",
            "老婆：你記得今天是什麼日子嗎？老公緊張地想了想：是...你的生日？老婆：不是。老公：結婚紀念日？老婆：也不是。老公：那是什麼日子？老婆：是可以刁難你的日子。",
            "朋友問：你怎麼瘦下來的？我：每天看銀行存款餘額，嚇都嚇瘦了。",
            "小時候以為長大後會有很多錢，長大後發現，果然...只是以為而已。",
            "人生就像一盒巧克力，但我的人生比較像一盒榴槤，不是每個人都能接受。",
            "我的減肥計畫很成功，計畫了三年，成功胖了十公斤。",
            "錢不是萬能的，但沒錢是萬萬不能的。比如說，沒錢你就看不到這則笑話，因為買不起手機。"
        ]
    },
    
    # === 辦公室笑話 ===
    {
        "category": "辦公室",
        "jokes": [
            "老闆說：我們是一個大家庭。我心想：難怪，在家裡我也不想工作。",
            "面試官：你最大的優點是什麼？我：我很誠實。面試官：我不覺得這是優點。我：我不在乎你怎麼想。",
            "週一的我：這週要好好努力！週五的我：下週一再說吧。",
            "老闆：為什麼你遲到了？員工：因為您說過，永遠不要為了工作犧牲家庭時間，所以我在家多睡了一會。",
            "開會就像看電視，大家都在，但沒人真的在聽。",
            "同事：你在忙什麼？我：忙著看起來很忙。",
            "績效考核就像天氣預報，大家都知道不太準，但還是要裝作很重要的樣子。",
            "下班時間到了，同事們移動的速度證明了，其實大家都可以很有效率。",
            "老闆說要 think outside the box，但薪水還是 inside the box。",
            "最恐怖的一句話：「我們來開個簡短的會議。」三小時後..."
        ]
    },
    
    # === 親子笑話 ===
    {
        "category": "親子",
        "jokes": [
            "爸爸：兒子，你知道什麼是勇敢嗎？兒子：知道！就是媽媽不在家的時候，你敢在沙發上吃洋芋片。",
            "小孩問：為什麼要上學？爸爸：為了學知識。小孩：那為什麼要學知識？爸爸：為了找好工作。小孩：那為什麼要找好工作？爸爸：為了養小孩上學...等等，我好像發現了什麼。",
            "女兒：爸爸，我是從哪裡來的？爸爸緊張：呃...你是...女兒：我知道了！我是從媽媽肚子裡來的，但我想知道我們家是從哪裡搬來的。",
            "媽媽：你的作業寫完了嗎？小明：寫完了！媽媽：真的？小明：真的，我寫完「作業」這兩個字了。",
            "老師：小華，你的作文《我的爸爸》怎麼和小明的一模一樣？小華：因為我們是兄弟，爸爸是同一個人啊！",
            "兒子：爸爸，為什麼大人可以罵小孩，小孩不能罵大人？爸爸：因為...你媽媽來了，快問她！",
            "小朋友的邏輯：餅乾掉在地上，三秒內撿起來，細菌還來不及爬上去。",
            "孩子問：為什麼要刷牙？媽媽：不刷牙會蛀牙。孩子：那為什麼爺爺都不用刷牙？媽媽：因為...爺爺很聰明，他把牙齒放在杯子裡。",
            "作文題目：《我的媽媽》。小明寫：我的媽媽是個美人，歲月請你別傷害她。如果你非要傷害，請找我爸爸。",
            "女兒：媽媽，我長大要嫁給爸爸！媽媽：不行，爸爸是我的。女兒：那我嫁給爺爺！媽媽：不行，爺爺是奶奶的。女兒生氣：你們大人真自私，好東西都不分享！"
        ]
    },
    
    # === 冷笑話 ===
    {
        "category": "冷笑話",
        "jokes": [
            "有一天，0 跟 8 在街上相遇，0 就對 8 說：「胖就胖，幹嘛繫皮帶！」",
            "為什麼飛機飛這麼高都不會撞到星星？因為星星會閃啊！",
            "有一個人叫小蔡，有一天他被端走了。",
            "石頭和年糕打架，石頭一腳把年糕踢進了大海。從此以後，這個年糕就叫什麼？石沉大海（石沉大 cake）。",
            "企鵝為什麼不會飛？因為企鵝是企業家，不是飛行家。",
            "有一天，麵包走在路上，突然覺得肚子餓，就把自己吃掉了。",
            "為什麼蠶寶寶很有錢？因為它會吐絲（吐錢）。",
            "什麼動物最容易跌倒？狐狸，因為狐狸狡猾（腳滑）。",
            "巧克力和番茄打架，為什麼巧克力贏了？因為巧克力棒（巧克力很棒）。",
            "有一隻鴨子叫小黃，有一天它過馬路被車撞了，從此就叫什麼？黃瓜（黃 quack）。"
        ]
    },
    
    # === 台灣在地笑話 ===
    {
        "category": "台灣在地",
        "jokes": [
            "為什麼台灣人喜歡排隊？因為排隊的時候可以滑手機，一舉兩得。",
            "在台北租房子最大的優點是什麼？可以體驗住在儲藏室的感覺，但付豪宅的價格。",
            "台灣的天氣預報：今天有雨，明天有雨，後天也有雨。簡單來說，出門記得帶傘。",
            "為什麼珍珠奶茶要用吸管？因為用筷子夾珍珠太累了。",
            "機車騎士的哲學：紅燈停，綠燈行，黃燈...衝啊！",
            "夜市老闆的數學：「一份50，三份100」。顧客：那我買兩份再買一份。老闆：...聰明，150元。",
            "捷運上最遠的距離，是我站在博愛座旁邊，卻不敢坐下去。",
            "台灣人的客氣：「不用啦！」「真的不用！」「好啦那就麻煩你了。」",
            "便利商店店員是全台灣最多才多藝的人：收銀、泡咖啡、收包裹、賣彩券，還要面帶微笑。",
            "颱風天最忙的是誰？氣象局？錯！是網友，忙著做颱風梗圖。"
        ]
    },
    
    # === 諧音梗笑話 ===
    {
        "category": "諧音梗",
        "jokes": [
            "我今天去看牙醫，醫生說我有一顆牙齒要拔掉，我說：「牙齒這麼勇敢為我服務這麼久，要拔（罷）工了嗎？」",
            "朋友問我為什麼不去髮廊，我說：「因為我和理髮師處不來，每次都是剪不斷理還亂。」",
            "老師：「同學們，什麼是壓力？」小明：「老師，鴨梨就是一種水果。」",
            "為什麼數學老師戴眼鏡？因為她要教學生除法（視力）。",
            "醫生對病人說：「你的肝有問題。」病人：「是感情的『感』嗎？」醫生：「不，是器官的『肝』，不過看你的樣子，感情應該也有問題。」",
            "昨天去買水果，老闆說芒果一斤60，我說：「忙什麼果，這麼貴！」",
            "朋友開了一家火鍋店，我問他生意怎麼樣，他說：「還不錯，就是有點火。」",
            "我問賣魚的老闆：「這魚新鮮嗎？」老闆：「新鮮到它自己都不知道自己已經死了。」",
            "為什麼歌手都喜歡站著唱歌？因為坐著唱就變成「坐唱」（做賬）了。",
            "朋友說他在學烘焙，我問：「那你現在是什麼等級？」他說：「麵包超人。」"
        ]
    },
    
    # === 動物笑話 ===
    {
        "category": "動物",
        "jokes": [
            "兩隻魚在聊天，一隻說：「我最近壓力好大。」另一隻說：「你住在深海，壓力當然大。」",
            "狗狗為什麼不能當醫生？因為它只會說：「汪汪（忘忘）」，老是忘記病人的病情。",
            "貓咪最喜歡什麼運動？瑜伽，因為它們天生就很會伸展。",
            "為什麼熊貓這麼受歡迎？因為它們自帶美顏效果：永遠的黑眼圈和圓圓臉。",
            "鸚鵡去應徵客服工作，面試官問：「你有什麼專長？」鸚鵡：「你有什麼專長？」面試官：「你被錄取了，完美的客服技能。」",
            "烏龜和兔子第二次賽跑，這次兔子沒有睡覺，但還是輸了。為什麼？因為烏龜叫了 Uber。",
            "蜜蜂為什麼嗡嗡叫？因為它們不會歌詞，只能哼旋律。",
            "魚為什麼不會講冷笑話？因為怕水溫下降。",
            "貓頭鷹為什麼是夜貓子？因為白天要上班當吉祥物。",
            "為什麼斑馬不能當裁判？因為它永遠都是穿著球衣。"
        ]
    },
    
    # === 校園笑話 ===
    {
        "category": "校園",
        "jokes": [
            "學生：老師，作業可以用鉛筆寫嗎？老師：為什麼？學生：這樣錯了還可以擦掉重寫。老師：那你乾脆不要寫。",
            "數學老師：如果你有10個蘋果，給了同學3個，還剩幾個？學生：10個。老師：為什麼？學生：因為我不會給。",
            "考試的時候，監考老師說：「請大家把和考試無關的東西放到講台上。」於是小明站起來往講台走去。",
            "老師：你為什麼遲到？學生：因為路上有人掉了100塊。老師：所以你幫他找？學生：不是，我踩著那100塊等失主。",
            "歷史老師：誰能告訴我古代皇帝的龍袍上繡的是什麼？小華：Made in China。",
            "英文老師：How are you? 學生：How are you? 老師：I'm fine, thank you. 學生：I'm fine, thank you. 老師：...你到底會不會？學生：你到底會不會？",
            "校長在朝會上說：「同學們要愛護學校，把學校當成自己家。」第二天，小明穿著睡衣拖鞋來上學。",
            "老師：小明，你的作文《如果我是校長》寫得很好，尤其是取消考試那段。小明：謝謝老師，您要不要連署？",
            "體育老師：今天我們要跑1600公尺。學生：老師，可以用走的嗎？老師：可以，但要在我跑完之前走完。",
            "音樂課上，老師問：「誰知道什麼是五線譜？」小明：「就是WiFi密碼的加強版。」"
        ]
    },
    
    # === 美食笑話 ===
    {
        "category": "美食",
        "jokes": [
            "客人：老闆，你們的招牌菜是什麼？老闆：就是門口那個招牌，不能吃。",
            "去吃到飽餐廳最大的敵人不是胃的容量，而是褲子的鬆緊帶。",
            "為什麼泡麵都是三分鐘？因為等四分鐘就太餓了，等兩分鐘又太硬。",
            "朋友說要帶我去吃「爆漿」美食，結果我的錢包先爆漿了。",
            "減肥的人看菜單：這個熱量多少？不減肥的人看菜單：這個多少錢？",
            "老婆：你要吃什麼？老公：隨便。老婆：那吃麵？老公：不要。老婆：那吃飯？老公：不要。老婆：那你到底要吃什麼？老公：隨便啊，除了麵和飯。",
            "為什麼火鍋店生意特別好？因為大家都喜歡在熱水裡撈錢（撈食物）。",
            "廚師最怕聽到的一句話：「這道菜我在家也會做。」",
            "點外送最痛苦的不是等待，而是外送員在你家樓下繞了10分鐘找不到門。",
            "什麼食物最有錢？鹹酥雞，因為它總是炸金（炸雞）。"
        ]
    }
]

# 網路流行梗和時事幽默
MEMES_AND_TRENDS = [
    "我不是胖，我只是把瘦的地方都藏起來了。",
    "成年人的生活沒有容易二字，除了容易胖。",
    "以前的手機是用來打電話的，現在的電話是用來找手機的。",
    "人生就像手機電量，早上100%，中午50%，下班前15%，還開啟省電模式。",
    "別人的周末：旅遊、聚餐、運動。我的周末：床、沙發、床。",
    "最遙遠的距離不是生與死，而是WiFi自動連接，密碼卻忘記了。",
    "現代人的三大錯覺：手機震動、有人敲門、她喜歡我。",
    "熬夜一時爽，一直熬夜一直爽。",
    "錢包就像洋蔥，每次打開都讓人想哭。",
    "我的興趣是把興趣當興趣，不要變成壓力。"
]

# 哲理幽默
PHILOSOPHICAL_HUMOR = [
    "人生如茶，第一道苦如生命，第二道甜如愛情，第三道淡如清風。第四道？沒水了，要加錢。",
    "活著的意義是什麼？大概是為了找出活著的意義吧。找到了嗎？還在找，你要一起嗎？",
    "他們說要活在當下，但我的當下只想躺下。",
    "人生就是不斷地放下，然而痛心的是，我還沒學會如何放下手機。",
    "佛說：放下執著。我說：好的，我放下減肥的執著。",
    "知識就是力量，但睡覺就是正義。",
    "人生三大真理：晚上不想睡、早上不想起、後悔昨天沒早睡。",
    "古人說：三思而後行。現代人：不思考，先發文。",
    "人生最大的謊言：「我就看看，不買。」",
    "智者千慮必有一失，我千慮之後發現，我可能不是智者。"
]


def create_joke_document(joke_text, category="綜合", user_id=None):
    """創建笑話文檔"""
    return {
        'text': joke_text,
        'user_id': user_id or f"系統_{category}",
        'timestamp': datetime.now(),
        'status': 'approved',
        'category': category,
        'likes': 0,
        'views': 0
    }


def seed_jokes():
    """將笑話種子資料寫入 Firestore"""
    # 初始化 Firestore
    db = firestore.Client()
    
    # 統計
    total_jokes = 0
    categories_count = {}
    
    logger.info("開始載入笑話種子資料...")
    
    # 批次寫入
    batch = db.batch()
    batch_count = 0
    
    # 處理分類笑話
    for category_data in JOKES_COLLECTION:
        category = category_data['category']
        jokes = category_data['jokes']
        categories_count[category] = len(jokes)
        
        for joke in jokes:
            doc_ref = db.collection('jokes').document()
            batch.set(doc_ref, create_joke_document(joke, category))
            batch_count += 1
            total_jokes += 1
            
            # Firestore 批次限制為 500
            if batch_count >= 500:
                batch.commit()
                logger.info(f"已提交 {batch_count} 則笑話")
                batch = db.batch()
                batch_count = 0
    
    # 處理網路流行梗
    for meme in MEMES_AND_TRENDS:
        doc_ref = db.collection('jokes').document()
        batch.set(doc_ref, create_joke_document(meme, "網路梗"))
        batch_count += 1
        total_jokes += 1
        
        if batch_count >= 500:
            batch.commit()
            batch = db.batch()
            batch_count = 0
    
    # 處理哲理幽默
    for humor in PHILOSOPHICAL_HUMOR:
        doc_ref = db.collection('jokes').document()
        batch.set(doc_ref, create_joke_document(humor, "哲理幽默"))
        batch_count += 1
        total_jokes += 1
        
        if batch_count >= 500:
            batch.commit()
            batch = db.batch()
            batch_count = 0
    
    # 提交剩餘的批次
    if batch_count > 0:
        batch.commit()
        logger.info(f"已提交最後 {batch_count} 則笑話")
    
    # 顯示統計
    logger.info(f"\n=== 笑話種子資料載入完成 ===")
    logger.info(f"總計載入笑話數：{total_jokes}")
    logger.info(f"\n各類別笑話數：")
    for category, count in categories_count.items():
        logger.info(f"  {category}: {count} 則")
    logger.info(f"  網路梗: {len(MEMES_AND_TRENDS)} 則")
    logger.info(f"  哲理幽默: {len(PHILOSOPHICAL_HUMOR)} 則")
    
    # 創建統計文檔
    stats_ref = db.collection('jokes_stats').document('summary')
    stats_ref.set({
        'total_jokes': total_jokes,
        'categories': list(categories_count.keys()) + ['網路梗', '哲理幽默'],
        'category_counts': {
            **categories_count,
            '網路梗': len(MEMES_AND_TRENDS),
            '哲理幽默': len(PHILOSOPHICAL_HUMOR)
        },
        'last_updated': datetime.now(),
        'seed_version': '1.0'
    })
    
    return total_jokes


def verify_jokes():
    """驗證笑話是否成功載入"""
    db = firestore.Client()
    
    # 檢查總數
    all_jokes = db.collection('jokes').stream()
    count = sum(1 for _ in all_jokes)
    logger.info(f"\n資料庫中的笑話總數：{count}")
    
    # 檢查各狀態的笑話數
    approved = db.collection('jokes').where('status', '==', 'approved').stream()
    approved_count = sum(1 for _ in approved)
    logger.info(f"已批准的笑話數：{approved_count}")
    
    # 隨機顯示幾則笑話
    logger.info("\n隨機樣本：")
    sample_jokes = db.collection('jokes').limit(5).stream()
    for i, joke_doc in enumerate(sample_jokes, 1):
        joke = joke_doc.to_dict()
        logger.info(f"{i}. {joke.get('text', 'No text')} (類別: {joke.get('category', 'Unknown')})")


if __name__ == "__main__":
    try:
        # 載入笑話
        total = seed_jokes()
        
        # 驗證結果
        logger.info("\n開始驗證...")
        verify_jokes()
        
        logger.info("\n✅ 笑話資料庫初始化成功！")
        logger.info(f"您現在有 {total} 則精彩笑話供用戶欣賞")
        
    except Exception as e:
        logger.error(f"❌ 載入笑話時發生錯誤：{e}")
        raise